<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV 報表</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-100 flex flex-col items-center py-8">

    <main class="w-full max-w-6xl bg-white border border-gray-200 rounded-xl shadow-md p-6 space-y-4">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">CSV 報表</h1>
        
        <!-- Copy Table Button -->
        <button id="copyTableBtn" 
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            複製表格到剪貼簿
        </button>

        <!-- Table Container -->
        <div id="tableContainer" class="overflow-x-auto mt-4"></div>
    </main>

    <script>
        /* --------------------------------------------------------
         * IndexedDB helper functions
         * -------------------------------------------------------- */
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open("CSV_DB", 1);
                request.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains("csvStore")) {
                        db.createObjectStore("csvStore", { keyPath: "id" });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function loadFromIndexedDB() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction("csvStore", "readonly");
                const store = tx.objectStore("csvStore");
                const req = store.get("csvData");
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
                req.onerror = reject;
            });
        }

        /* --------------------------------------------------------
         * 載入 CSV 資料
         * -------------------------------------------------------- */
        async function loadCSVData() {
            const mode = localStorage.getItem("storageMode");

            if (mode === "localStorage") {
                const data = JSON.parse(localStorage.getItem("csvData") || "[]");
                console.log("Loaded from localStorage:", data);
                return data;
            }

            if (mode === "indexedDB") {
                const data = await loadFromIndexedDB() || [];
                console.log("Loaded from IndexedDB:", data);
                return data;
            }

            return [];
        }

        function getChineseLabel(value, chinese) {
            const found = chinese.find(item => item.value === value);
            return found ? found.label : value;
        }

        /* --------------------------------------------------------
         * 建立表格
         * -------------------------------------------------------- */
        function renderTable(csvData, header, chinese) {
            const tableContainer = document.getElementById("tableContainer");

            if (!csvData || csvData.length === 0) {
                tableContainer.innerHTML = '<p class="text-gray-600">沒有可顯示的資料</p>';
                return;
            }

            let tableHTML = '<table style="border-collapse: collapse; width: 100%;">';
            tableHTML += '<thead><tr>';

            const tableHeader = header.length ? header : Object.keys(csvData[0]);
            tableHeader.forEach(col => {
                const label = getChineseLabel(col, chinese);
                tableHTML += `<th style="border:1px solid #ccc; padding:4px; background-color:#f0f0f0; text-align:left;">${label}</th>`;
            });

            tableHTML += '</tr></thead><tbody>';

            csvData.forEach(row => {
                tableHTML += '<tr>';
                tableHeader.forEach(col => {
                    tableHTML += `<td style="border:1px solid #ccc; padding:4px;">${row[col] ?? ''}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            tableContainer.innerHTML = tableHTML;
        }

        /* --------------------------------------------------------
         * 複製表格到剪貼簿
         * -------------------------------------------------------- */
        document.getElementById('copyTableBtn').addEventListener('click', () => {
            const table = document.querySelector('#tableContainer table');
            if (!table) return alert('沒有可複製的表格！');

            const range = document.createRange();
            range.selectNode(table);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            document.execCommand('copy');
            selection.removeAllRanges();

            alert('表格已複製！');
        });

        /* --------------------------------------------------------
         * 初始化
         * -------------------------------------------------------- */
        async function init() {
            const csvData = await loadCSVData();
            const header = JSON.parse(localStorage.getItem('header') || '[]');
            const chinese = JSON.parse(localStorage.getItem('chinese') || '[]');
            renderTable(csvData, header, chinese);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>

</body>
</html>
